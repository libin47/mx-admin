import{ea as W,eb as X,ec as Z,ed as M,ee,ef as te,eg as ae,dS as ne,bu as le,f as S,H as g,w as F,a as e,E as A,j as J,n as H,eh as re,p as se,ct as ue,c7 as I,u as oe,bs as ie,R as h,dQ as D,L as N,b_ as O,m as k,ei as C,aN as ce,y as pe,ej as de,b$ as fe,c1 as z,N as b,b5 as me,S as G,b as w,F as T,q as ve,$ as ye,A as ge,d as E,I as j,ek as he,g as we,C as be}from"./index-d12868e1.js";import{H as V}from"./rounded-button-527354c9.js";import{u as K}from"./use-react-c61188f0.js";import{d as Se,l as q}from"./js-yaml-fae8e8ce.js";import{T as Ne}from"./two-col-0d24fac9.js";import{F as Fe,S as _e,d as xe,a as y,b as ke}from"./index-f1337b14.js";import{a as Ce,p as R}from"./use-async-monaco-384bd4e7.js";import{_ as Oe}from"./CheckCircleOutlined-6d74dc14.js";import{g as Te,b as $e}from"./_baseClone-43b52ff9.js";import{N as L}from"./Form-ba393540.js";import{N as v}from"./FormItem-c40e0e72.js";import{N as Ae}from"./Select-07750eb4.js";import{N as Ve}from"./Switch-1916f3ad.js";import{D as Le}from"./delete-confirm-7d1aef80.js";import{T as Pe}from"./index-f95bd1a6.js";import{R as De}from"./relative-time-9a65b4e3.js";import{u as Ee}from"./use-table-37559345.js";import{C as Y}from"./index-0ec46b47.js";import{E as je}from"./ExternalLink-318ead10.js";import{N as U}from"./Tag-ae5139ae.js";import{N as qe}from"./Popconfirm-45d3c0d9.js";import{N as Re,a as B}from"./Tabs-a002909d.js";import"./editor.main-8d5a4ff7.js";import"./use-save-confirm-e6ccd567.js";import"./index-17c3e39a.js";import"./DataTable-5dd6fcfc.js";import"./ChevronRight-0b09885c.js";import"./Checkbox-ae25cf48.js";import"./Tooltip-a8c15ee0.js";import"./Pagination-10cdbb22.js";import"./Forward-afd84277.js";import"./prop-0f12dfb2.js";import"./Add-7dfeb60a.js";import"./throttle-6b7e9902.js";function Ue(a){var l=a==null?0:a.length;return l?a[l-1]:void 0}function Be(a,l){return l.length<2?a:W(a,X(l,0,-1))}function Me(a,l){return l=M(l,a),a=Be(a,l),a==null||delete a[Z(Ue(l))]}function Je(a){return ee(a)?void 0:a}var He=1,Ie=2,ze=4,Ge=te(function(a,l){var s={};if(a==null)return s;var n=!1;l=ae(l,function(p){return p=M(p,a),n||(n=p.length>1),p}),ne(a,Te(a),s),n&&(s=$e(s,He|Ie|ze,Je));for(var u=l.length;u--;)Me(s,l[u]);return s}),Ke=Ge,Q={};Object.defineProperty(Q,"__esModule",{value:!0});const x=le,Ye={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 1024 1024"},Qe=(0,x.createElementVNode)("path",{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM540 701v53c0 4.4-3.6 8-8 8h-40c-4.4 0-8-3.6-8-8v-53a48.01 48.01 0 1 1 56 0zm152-237H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224z",fill:"currentColor"},null,-1),We=[Qe];var Xe=Q.default=(0,x.defineComponent)({name:"LockFilled",render:function(l,s){return(0,x.openBlock)(),(0,x.createElementBlock)("svg",Ye,We)}});const Ze=S({props:{onSave:{type:Function},value:{type:String,required:!0},onChange:{type:Function,required:!0},language:{type:String,required:!0}},setup(a){const l=Ce(a),s=g();return F(()=>l.value,()=>{!s.value||s.value.loaded&&a.onChange(l.value)}),()=>e("div",{class:"h-full w-full relative"},[e(Fe,{ref:s,value:l,onSave:a.onSave,language:a.language},null)])}}),et=S({setup(){const a=A(),l=J(),s=H(()=>l.query.id),n=re(s.value?`snippet-${s.value}`:"snippet",new _e),u=se(s.value?{json:"",yaml:"",text:"",function:""}:{json:JSON.stringify({name:"hello world"},null,2),text:"",yaml:"name: hello world",function:xe});F(()=>n.value.type,r=>{n.value.raw=u[r]}),F(()=>[u.json,u.yaml],ue(([r,t],[i,c])=>{const f=r!==i,m=t!==c,P=ie(u);try{f?P.yaml=Se(JSON.parse(r)):m&&(P.json=JSON.stringify(q(t),null,2))}catch{}},100)),F(()=>[n.value.type,n.value.schema],([r,t])=>{if(r===y.JSON){if(!n.value.schema){O(()=>import("./editor.main-8d5a4ff7.js").then(function(c){return c.e}),["js/editor.main-8d5a4ff7.js","assets/editor.main.339eee99.css","js/index-d12868e1.js","assets/index.f746a3c0.css"]).then(c=>{c.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!1})});return}const i=n.value.schema;fetch(i).then(c=>c.text()).then(c=>{O(()=>import("./editor.main-8d5a4ff7.js").then(function(f){return f.e}),["js/editor.main-8d5a4ff7.js","assets/editor.main.339eee99.css","js/index-d12868e1.js","assets/index.f746a3c0.css"]).then(f=>{f.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!0,schemas:[{uri:i,fileMatch:["*"],schema:JSON.parse(c)}]})})})}}),F(()=>s,async r=>{if(r.value){const t=await h.api.snippets(r.value).get();switch(t.type){case y.JSON:{t.raw=JSON.stringify(JSON.parse(t.raw),null,2);break}}n.value=t,u[t.type]=t.raw}},{immediate:!0});const p=I(),o=oe(),d=async(r=!0)=>{const t=m=>{try{return JSON.stringify(JSON.parse(m),null,0)}catch{o.error("JSON \u683C\u5F0F\u9519\u8BEF")}},i=()=>{const m=u[n.value.type];switch(n.value.type){case y.JSON:return t(m);case y.YAML:{try{q(m)}catch{o.error("YAML \u683C\u5F0F\u9519\u8BEF")}return m}case y.Function:return m;default:return m}},f={...Ke(n.value,["_id","id","created","data"]),raw:i()};f.metatype||delete f.metatype,s.value?await h.api.snippets(s.value).put({data:f}):await h.api.snippets.post({data:f}),o.success(`${s.value?"\u66F4\u65B0":"\u521B\u5EFA"}\u6210\u529F`),r&&a.replace({query:{...l.query,tab:0}})};return K(()=>(p.setHeaderButtons(e(V,{variant:"success",onClick:()=>d(),icon:e(Oe,null,null)},null)),()=>{p.setHeaderButtons(null)})),()=>e(Ne,null,{default:()=>[e(D,{span:12},{default:()=>[e(L,null,{default:()=>[e(v,{label:"\u540D\u79F0",required:!0},{default:()=>[e(N,{onUpdateValue:r=>void(n.value.name=r),value:n.value.name},null)]}),e(v,{label:"\u5F15\u7528",required:!0},{default:()=>[e(N,{value:n.value.reference,onUpdateValue:r=>void(n.value.reference=r),defaultValue:"root"},null)]}),e(v,{label:"\u5143\u7C7B\u578B"},{default:()=>[e(N,{value:n.value.metatype,onUpdateValue:r=>void(n.value.metatype=r)},null)]}),e(v,{label:"\u6570\u636E\u7C7B\u578B"},{default:()=>[e(Ae,{value:n.value.type,defaultValue:y.JSON,onUpdateValue:r=>void(n.value.type=r),options:Object.entries(y).map(([r,t])=>({label:r,value:t}))},null)]}),e(v,{label:"Schema"},{default:()=>[e(N,{value:n.value.schema,onUpdateValue:r=>void(n.value.schema=r)},null)]}),e(v,{label:"\u516C\u5F00",labelPlacement:"left"},{default:()=>[e("div",{class:"w-full flex justify-end"},[e(Ve,{value:!n.value.private,onUpdateValue:r=>void(n.value.private=!r)},null)])]}),e(v,{label:"\u5907\u6CE8"},{default:()=>[e(N,{resizable:!1,value:n.value.comment,onUpdateValue:r=>void(n.value.comment=r),type:"textarea",rows:4},null)]})]})]}),e(D,{span:24},{default:()=>[e(Ze,{onSave:async()=>{await d(!1),o.success("Saved!")},language:ke[n.value.type],value:u[n.value.type],onChange:r=>{u[n.value.type]=r}},null)]})]})}}),tt=S({props:{language:{type:String,required:!0},code:{type:String,required:!0}},setup(a){const l=g();return k(()=>{O(()=>import("./editor.main-8d5a4ff7.js").then(function(s){return s.e}),["js/editor.main-8d5a4ff7.js","assets/editor.main.339eee99.css","js/index-d12868e1.js","assets/index.f746a3c0.css"]).then(s=>{s.editor.colorize(a.code,a.language,{tabSize:2}).then(n=>{l.value.innerHTML=n})})}),()=>e("pre",{ref:l},[a.code])}});var _;(a=>{async function l(){return(await C.rest.repos.get({owner:"mx-space",repo:"snippets"})).data}a.fetchRepo=l;async function s(u=""){return(await C.rest.repos.getContent({owner:"mx-space",repo:"snippets",path:u})).data}a.fetchFileTree=s;async function n(u=""){return(await C.rest.search.code({q:`repo:mx-space/snippets in:path ${u}`,sort:"indexed",order:"desc"})).data}a.searchFile=n})(_||(_={}));function $(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!G(a)}const at=()=>{const a=g([]),l=g(!0);return[a,async()=>{const n=await _.fetchFileTree();Array.isArray(n)&&(a.value=n.filter(({type:u})=>u==="dir").map(({name:u,html_url:p})=>({name:u,url:p||""}))),l.value=!1},l]},nt=S({props:{onFinish:{type:Function,required:!0}},setup(a){const l=g(!1),s=t=>{t.stopPropagation(),t.preventDefault(),r()},[n,u,p]=at();ce(()=>{l.value&&u()});const o=g(""),d=pe(),r=async()=>{const t=d.create({title:"\u83B7\u53D6\u548C\u89E3\u6790",content:()=>ye(lt,{name:o.value,onFinish:()=>{t.destroy(),a.onFinish()}}),closable:!0})};return()=>e(T,null,[e(V,{variant:"info",onClick:()=>{l.value=!0},icon:e(de,null,null)},null),e(fe,{show:l.value,onUpdateShow:t=>{l.value=t}},{default:()=>[e(z,{class:"modal-card sm",title:"\u5BFC\u5165 Snippets"},{default:()=>[e(L,{onSubmit:s},{default:()=>[e(v,{label:"\u5305\u540D"},{default:()=>[e(N,{placeholder:"\u652F\u6301\u5BFC\u5165 GitHub repo:mx-space/snippets \u4E0B\u7684\u96C6\u5408\u5305\uFF0C\u793A\u4F8B\u8F93\u5165: kami",value:o.value,onUpdateValue:t=>{o.value=t}},null)]}),e(v,{label:"\u53EF\u83B7\u53D6\u7684"},{default:()=>[p.value?e(Y,null,null):e("div",{class:"flex flex-wrap space-x-2"},[n.value.map(({name:t,url:i})=>e("div",{class:"flex items-center ml-4",key:"name"},[e(b,{text:!0,onClick:()=>{o.value=t,me(()=>{r()})}},$(t)?t:{default:()=>[t]}),e("a",{href:i,target:"_blank",rel:"noopener noreferrer"},[e(je,{class:"!h-4 !w-4 ml-2"},null)])]))])]}),e("div",{class:"flex justify-end"},[e(b,{round:!0,type:"primary",onClick:r},{default:()=>[w("\u5904\u7406")]})])]})]})]})])}}),lt=S({props:{name:{type:String,required:!0},onFinish:{type:Function,required:!0}},setup(a){const l=g(!0),s=g([]),n=g([]);k(async()=>{const p=await _.fetchFileTree(a.name);if(Array.isArray(p)){const o=p.map(async d=>{if(d.type==="dir")switch(d.name){case"functions":{const r=await _.fetchFileTree(`${a.name}/functions`);Array.isArray(r)&&await Promise.all(r.map(async t=>{if(t.type==="file"&&/\.(js|ts)$/.test(t.name)){const i=t.download_url;if(!i){message.error(`\u83B7\u53D6\u4E0B\u8F7D\u5730\u5740\u5931\u8D25, ${t.name}`);return}const c=await fetch(i).then(f=>f.text());console.log(`// ${t.name}
${c}`),s.value.push({name:t.name,reference:a.name,raw:c,htmlUrl:t.html_url})}}));break}}else if(d.name==="package.json"){const r=d.download_url;if(!r){message.error("\u65E0\u6CD5\u83B7\u53D6 package.json \u6587\u4EF6\u7684\u4E0B\u8F7D\u5730\u5740");return}const t=await fetch(r).then(c=>c.text()),i=JSON.parse(t);console.log("// package.json"),console.log(i),n.value=Object.entries(i.dependencies||{}).map(([c,f])=>`${c}@${f}`)}});await Promise.all(o),l.value=!1}});const u=async()=>{const p={snippets:s.value.map(d=>({name:R.basename(d.name,R.extname(d.name)),reference:d.reference,raw:d.raw,private:!1,type:y.Function})),packages:unref(n)},o=message.loading("\u6B63\u5728\u5BFC\u5165...",{duration:1e6});await h.api.snippets.more.post({data:p,timeout:1e6}),o.destroy(),message.success("\u5BFC\u5165\u6210\u529F"),a.onFinish()};return()=>{const{name:p}=a;return e("div",null,[e("p",null,[w("\u83B7\u53D6\uFF1A "),p]),l.value?e("div",{class:"h-24 relative"},[e(Y,{description:"\u9700\u8981\u4ECE GitHub \u83B7\u53D6\uFF0C\u5EFA\u8BAE\u8FDE\u63A5\u4EE3\u7406\u540E\u64CD\u4F5C\u3002"},null)]):e(L,null,{default:()=>[e(v,{label:"\u5C06\u5BFC\u5165\u7684\u51FD\u6570\uFF1A"},{default:()=>[e("div",{class:"space-x-2"},[s.value.map(({name:o,reference:d,raw:r,htmlUrl:t},i)=>e(ve,{key:`${d}/${o}`,trigger:"hover",placement:"right"},{trigger(){return e(b,{text:!0,onClick:()=>{t&&window.open(t)},class:"cursor-pointer"},{default:()=>[e(U,{closable:!0,onClose:c=>{c.stopPropagation(),s.value.splice(i,1)}},$(o)?o:{default:()=>[o]})]})},default(){return e(z,{bordered:!1,title:o,class:"max-w-[40vw] max-h-[50vh] overflow-auto"},{default:()=>[e(tt,{code:r,language:"typescript"},null)]})}}))])]}),e(v,{label:"\u5C06\u5B89\u88C5\u7684\u4F9D\u8D56\uFF1A"},{default:()=>[e("div",{class:"space-x-2"},[n.value.map((o,d)=>e(U,{closable:!0,key:o,onClose:()=>{n.value.splice(d,1)}},$(o)?o:{default:()=>[o]}))])]}),e("div",{class:"flex justify-end"},[e(b,{round:!0,type:"primary",onClick:u},{default:()=>[w("\u5BFC\u5165")]})])]})])}}});function rt(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!G(a)}const st=()=>{const a=g([]),l=async()=>{const s=await h.api.snippets.aggregate.post({data:[{$group:{_id:"$reference"}},{$project:{name:"$_id",_id:!1}}]});a.value=s.data.map(({name:n})=>n)};return k(()=>{l()}),a},ut=S({setup(){const{data:a,fetchDataFn:l,loading:s,pager:n,checkedRowKeys:u}=Ee((r,t)=>async(i,c,f)=>{const m=await h.api.snippets.get({params:{page:i,size:c,select:"-raw",db_query:f}});r.value=m.data,t.value=m.pagination}),p=st();k(()=>{l(1,20)});const o=I();K(()=>(o.setHeaderButtons(e(T,null,[e(V,{onClick:()=>{d.push({query:{tab:1}})},icon:e(ge,null,null)},null),e(nt,{onFinish:()=>{l()}},null),e(Le,{checkedRowKeys:u,onDelete:async r=>{!r||(await Promise.all(r.map(t=>h.api.snippets(t).delete())),l(1,20),u.value.length=0)}},null)])),()=>{o.setHeaderButtons(null)}));const d=A();return()=>{const r=p.value.map(t=>({label:t,value:t}));return e(T,null,[e(Pe,{onUpdateCheckedRowKeys:t=>{u.value=t},data:a,nTableProps:{onUpdateFilters(t){t.reference&&t.reference.length?l(1,20,{$or:t.reference.map(i=>({reference:i}))}):l(1,20)}},pager:n,columns:[{type:"selection",options:["none","all"]},{key:"name",title:"\u540D\u79F0",render(t){const i=t.name,c=t.private;return e(E,{align:"center"},{default:()=>[t.type===y.Function&&e(j,null,{default:()=>[e(he,null,null)]}),e(b,{tag:"a",text:!0,href:`${h.endpoint+(t.type===y.Function?"/fn/":"/snippets/")+t.reference}/${t.name}${t.private?`?token=${we()}`:""}`,target:"_blank",size:"tiny"},rt(i)?i:{default:()=>[i]}),c&&e(j,{class:"items-center flex "},{default:()=>[e(Xe,null,null)]})]})}},{title:"\u7C7B\u578B",key:"type"},{title:"\u5F15\u7528",key:"reference",filter:!0,filterOptions:r},{key:"comment",title:"\u5907\u6CE8",width:300,ellipsis:{tooltip:!0}},{title:"\u521B\u5EFA\u4E8E",key:"created",render(t){return e(De,{time:t.created},null)}},{title:"\u64CD\u4F5C",key:"id",fixed:"right",render(t){return e(E,null,{default:()=>[e(b,{text:!0,size:"tiny",type:"primary",onClick:()=>{d.push({query:{tab:1,id:t.id}})}},{default:()=>[w("\u7F16\u8F91")]}),e(qe,{positiveText:"\u53D6\u6D88",negativeText:"\u5220\u9664",onNegativeClick:async()=>{await h.api.snippets(t.id).delete(),message.success("\u5220\u9664\u6210\u529F"),await l(n.value.currentPage)}},{trigger:()=>e(b,{text:!0,type:"error",size:"tiny"},{default:()=>[w("\u79FB\u9664")]}),default:()=>e("span",{class:"max-w-48"},[w("\u786E\u5B9A\u8981\u5220\u9664 "),t.title,w(" ?")])})]})}}],loading:s.value},null)])}}});var Mt=S({name:"SnippetView",setup(){const a=J(),l=A(),s=H(()=>a.query.tab||"0");return()=>e(be,null,{default:()=>[e(Re,{size:"medium",value:s.value,onUpdateValue:n=>{l.push({query:{tab:n}})}},{default:()=>[e(B,{name:"0",tab:"\u5217\u8868"},{default:()=>[e(ut,null,null)]}),e(B,{name:"1",tab:"\u7F16\u8F91",displayDirective:"if"},{default:()=>[e(et,null,null)]})]})]})}});export{Mt as default};
