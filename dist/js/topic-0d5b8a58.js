import{f as C,H as m,a as e,N as h,I as S,b as N,bQ as F,bS as T,d2 as k,R as g,d3 as w,b5 as P,g as L,S as q,F as x,d4 as H,m as E,A as O,cy as _,p as J,w as U,L as y,s as W,d5 as G,E as Q,j as K,C as X}from"./index-d885f019.js";import{H as Y}from"./rounded-button-6475331c.js";import{u as Z}from"./use-table-f4b6379e.js";import{I as ee}from"./iframe-preview-f468e6b6.js";import{U as j}from"./index-1346df36.js";import{S as te}from"./Search24Regular-bc462b7e.js";import{N as ae}from"./Upload-4b8d56b9.js";import{N as D}from"./Avatar-2ed00750.js";import{a as le,N as ne}from"./Select-f7ce401c.js";import{N as A,a as B}from"./ListItem-1c574609.js";import{T as M}from"./Trash-687c26dd.js";import{N as V}from"./Pagination-929c7ebe.js";import{N as $}from"./Popconfirm-9e91c519.js";import{N as re}from"./Form-1d9f54f3.js";import{N as b}from"./FormItem-f234e47c.js";import{N as ue}from"./ButtonGroup-e00e1490.js";import"./Add-cf9d4bc6.js";import"./Image-e873f022.js";import"./Tooltip-dfa056a2.js";import"./Tag-b4c59312.js";import"./Forward-8c76bb04.js";import"./prop-0f12dfb2.js";import"./index-ed7b3e6e.js";const R=l=>{if(!l)return"";const t=l.split(" ")[0];return t.length>4?l[0]:t};function se(l){return typeof l=="function"||Object.prototype.toString.call(l)==="[object Object]"&&!q(l)}const oe=C({props:{id:{type:String,required:!0}},setup(l){const t=m(!1),a=m(null),i=m([]),d=m(),p=m(!0),f=async()=>{t.value=!0;const r=await g.api.topics(l.id).get();a.value=r,await n(r.id)},n=async(r,u=1,s=5)=>{p.value=!0;const{data:o,pagination:v}=await g.api.notes.topics(r).get({params:{page:u,size:s}});return p.value=!1,i.value=o,d.value=v,{data:o,pagination:v}},c=async r=>{await g.api.notes(r).patch({data:{topicId:null}}),message.success("\u5DF2\u79FB\u9664\u6587\u7AE0\u7684\u4E13\u680F\u5F15\u7528");const u=i.value.findIndex(s=>s.id===r);-~u&&i.value.splice(u,1)};return()=>{let r;return e(x,null,[e(h,{size:"small",secondary:!0,onClick:f},{default:()=>[e(S,{class:"mr-1"},{default:()=>[e(te,null,null)]}),N("\u8BE6\u60C5")]}),e(F,{show:t.value,closable:!0,onClose:()=>{t.value=!1},closeOnEsc:!0,onUpdateShow:u=>{t.value=u}},{default:()=>[a.value?e(T,{closable:!0,role:"dialog",class:"modal-card md",title:`\u4E13\u680F - ${a.value.name}`},{default:()=>[e(k,null,{avatar(){return e(j,{class:"p0",type:"icon",onFinish:u=>{const s=JSON.parse((u.event?.target).responseText);return u.file.url=s.url,a.value&&g.api.topics(a.value.id).patch({data:{icon:s.url}}).then(()=>{a.value&&(a.value.icon=s.url)}),u.file},onError:u=>{try{const s=JSON.parse((u.event?.target).responseText);message.warning(s.message)}catch{}return u.file}},{default:()=>[e(ae,null,{default:()=>[e(D,{size:60,class:"rounded-xl bg-transparent",src:a.value?.icon||void 0},{default:()=>[a.value?.icon?void 0:R(a.value?.name)]})]})]})},header(){return e("b",null,[a.value?.name])},"header-extra":function(){return e("span",{class:"opacity-80"},[a.value?.slug])},description(){return e("p",{class:"opacity-90 clamp-2 break-all"},[a.value?.introduce])},default(){return e("p",null,[a.value?.description])}}),p.value&&i.value.length==0?e(w,{animated:!0,class:"mt-2 h-[350px]"},null):e("div",{class:"mt-4"},[e("p",{class:"flex justify-between items-center"},[e("strong",null,[N("\u5305\u542B\u7684\u6587\u7AE0\uFF1A")]),e(ce,{topicId:a.value.id,onSuccess:()=>{P(()=>f())}},null)]),i.value.length===0&&e("div",{class:"h-[300px] flex items-center justify-center"},[e(le,{description:"\u8FD9\u91CC\u8FD8\u6CA1\u6709\u4EFB\u4F55\u5185\u5BB9"},null)]),e(A,{bordered:!0,class:"mt-2"},se(r=i.value.map(u=>e(B,{key:u.id},{default(){return e("p",{class:"space-x-2 flex items-center"},[e("span",null,[u.title]),e(ee,{path:(()=>`${g.endpoint}/markdown/render/${u.id}${`?token=${L()}`}`)()},null)])},suffix(){return e($,{onPositiveClick:()=>c(u.id)},{trigger(){return e(h,{circle:!0,tertiary:!0,type:"error"},{default:()=>[e(S,null,{default:()=>[e(M,null,null)]})]})},default(){return`\u662F\u5426\u79FB\u9664\u6B64\u8BDD\u9898\u300C${a.value?.name}\u300D\uFF1F`}})}})))?r:{default:()=>[r]}),e("div",{class:"flex justify-end"},[d.value&&e(V,{class:"mt-4",onUpdatePage:u=>{n(l.id,u)},page:d.value.currentPage,pageCount:d.value.totalPage},null)])])]}):e(T,{class:"modal-card md",role:"dialog",title:"\u4E13\u680F\u4FE1\u606F\u83B7\u53D6\u4E2D"},{default:()=>[e("div",{class:"flex relative gap-2 "},[e(w,{animated:!0,circle:!0,width:60},null),e("div",{class:"flex-grow"},[e(w,{animated:!0,text:!0,repeat:3,class:"flex-grow"},null)])]),e(w,{animated:!0,repeat:2,class:"mt-2",text:!0},null)]})]})])}}}),ie=H(()=>{const l=m([]),t=new Set;let a=0,i=!1;const d=m(!0),p=async(f=1)=>{d.value=!0;const{data:n,pagination:c}=await g.api.notes.get({params:{page:f,size:50,select:"nid title _id id"}});l.value.push(...n.filter(r=>!t.has(r.id))),d.value=!1,n.forEach(r=>t.add(r.id)),a=c.currentPage,c.hasNextPage||(i=!0)};return{loading:d,notes:l,fetchNext:()=>{i||p(a+1)},refresh:()=>{a=1,i=!1,l.value=[],p(a)}}}),ce=C({props:{topicId:{type:String,required:!0},onSuccess:{type:Function,required:!1}},setup(l){const t=m(!1),a=async()=>{const r=_(n);await Promise.all(r.map(u=>g.api.notes(u).patch({data:{topicId:l.topicId}}))),message.success("\u6DFB\u52A0\u6210\u529F"),t.value=!1,l.onSuccess?.(r)},{refresh:i,fetchNext:d,notes:p,loading:f}=ie(),n=m([]),c=r=>{const u=r.currentTarget;u.scrollTop+u.offsetHeight+10>=u.scrollHeight&&d()};return E(()=>{p.value.length===0&&d()}),()=>e(x,null,[e(h,{secondary:!0,type:"success",circle:!0,onClick:()=>{t.value=!0}},{default:()=>[e(S,null,{default:()=>[e(O,null,null)]})]}),e(F,{closable:!0,closeOnEsc:!0,show:t.value,onUpdateShow:r=>{t.value=r}},{default:()=>[e(T,{title:"\u54EA\u4E9B\u6587\u7AE0\u9700\u8981\u6DFB\u52A0\u5230\u4E13\u680F\uFF1F",class:"modal-card sm"},{footer(){return e("div",{class:"text-right"},[e(h,{round:!0,type:"success",onClick:()=>a()},{default:()=>[N("\u6DFB\u52A0\uFF01")]})])},default(){return e(ne,{maxTagCount:3,filterable:!0,clearable:!0,loading:f.value,multiple:!0,onClear:()=>{i()},value:n.value,onUpdateValue:r=>{n.value=r},resetMenuOnOptionsChange:!1,options:p.value.map(r=>({label:r.title,value:r.id,key:r.id})),onScroll:c},null)}})]})])}}),de=C({props:{show:{type:Boolean,required:!0},onClose:{type:Function,required:!0},id:{type:String,required:!1},onSubmit:{type:Function,required:!1}},setup(l){const t=J({}),a=m(!1),i=()=>{Object.keys(t).forEach(n=>{delete t[n]})};U(()=>l.id,n=>{n?(a.value=!0,g.api.topics(n).get().then(c=>{Object.assign(t,c),a.value=!1})):i()});const d=()=>{l.onClose()},p=()=>{f?.value?.validate(async c=>{c?.length||await n()});async function n(){let c;l.id?(c=await g.api.topics(l.id).put({data:t}),message.success("\u4FEE\u6539\u6210\u529F")):(c=await g.api.topics.post({data:t}),message.success("\u6DFB\u52A0\u6210\u529F")),l.onSubmit?.(c),P(()=>{i()})}},f=m();return()=>e(x,null,[e(F,{show:l.show,onUpdateShow:d,closable:!0,onClose:d,transformOrigin:"center"},{default:()=>[e(T,{role:"dialog",title:"\u65B0\u5EFA\u8BDD\u9898",closable:!0,onClose:d,class:"modal-card sm"},{default:()=>[e(re,{labelPlacement:"top",ref:f,model:t,disabled:a.value},{default:()=>[e(b,{label:"\u540D\u5B57",required:!0,rule:{max:50,required:!0,trigger:["blur","input"]},path:"name"},{default:()=>[e(y,{value:t.name,onUpdateValue:n=>{t.name=n}},null)]}),e(b,{label:"id",required:!0,rule:{required:!0,trigger:["blur","input"]},path:"slug"},{default:()=>[e(y,{value:t.slug,onUpdateValue:n=>{t.slug=n}},null)]}),e(b,{label:"\u7B80\u4ECB",required:!0,rule:{max:100,required:!0,trigger:["blur","input"]},path:"introduce"},{default:()=>[e(y,{value:t.introduce,onUpdateValue:n=>{t.introduce=n}},null)]}),e(b,{label:"\u56FE\u6807"},{default:()=>[e(y,{value:t.icon,onUpdateValue:n=>{t.icon=n}},{suffix(){return e(j,{class:"flex items-center",type:"icon",onFinish:n=>{const c=JSON.parse((n.event?.target).responseText);return n.file.url=c.url,t.icon=n.file.url,n.file}},{default:()=>[e(h,{text:!0},{default:()=>[e(W,null,{default:()=>[e(G,null,null)]})]})]})}})]}),e(b,{label:"\u957F\u63CF\u8FF0",rule:{max:500,trigger:["blur","input"]},path:"description"},{default:()=>[e(y,{type:"textarea",autosize:{maxRows:5,minRows:2},value:t.description,onUpdateValue:n=>{t.description=n}},null)]}),e("div",{class:"flex justify-end gap-2"},[e(h,{round:!0,type:"primary",onClick:p},{default:()=>[N("\u63D0\u4EA4")]})])]})]})]})])}});function pe(l){return typeof l=="function"||Object.prototype.toString.call(l)==="[object Object]"&&!q(l)}var Ae=C({setup(){const l=Q(),t=K();U(()=>t.query.page,s=>{a(s?+s:0)});const{fetchDataFn:a,data:i,pager:d}=Z((s,o)=>async(v=parseInt(t.query.page)||1,z=20)=>{const I=await g.api.topics.get({page:v,size:z});return o.value=I.pagination,s.value=I.data,I});E(()=>a());const p=m(""),f=m(!1),n=()=>{f.value=!0,p.value=""},c=()=>{f.value=!1,p.value=""};return{pagination:d,topics:i,fetchTopic:a,handleAddTopic:n,editTopicId:p,showTopicModal:f,handleCloseModal:c,handleSubmit(s){c();const o=i.value.findIndex(v=>v.id===s.id);-~o?i.value[o]=s:i.value.push(s)},handleDelete:async s=>{await g.api.topics(s).delete(),a()},handleEdit:s=>{p.value=s,f.value=!0},route:t,router:l}},render(){const{pagination:l,topics:t,router:a,route:i,editTopicId:d,showTopicModal:p,handleAddTopic:f,handleCloseModal:n,handleSubmit:c,handleEdit:r,handleDelete:u}=this;return e(X,null,{actions(){return e(x,null,[e(Y,{icon:e(O,null,null),onClick:f,variant:"success"},null)])},default(){let s;return e(x,null,[e(A,{bordered:!0,class:"mb-4"},pe(s=t.map(o=>e(B,{key:o.id},{prefix(){return e(D,{"data-src":o.icon,class:`mt-2 ${o.icon&&"!bg-transparent"}`,circle:!0,size:50,src:o.icon||void 0},{default:()=>[o.icon?void 0:R(o.name)]})},suffix(){return e(ue,null,{default:()=>[e(h,{round:!0,onClick:()=>r(o.id)},{default:()=>[N("\u7F16\u8F91")]}),e($,{onPositiveClick:()=>u(o.id)},{default(){return`\u786E\u5B9A\u5220\u9664\u300C${o.name}\u300D\uFF1F`},trigger(){return e(h,{circle:!0,tertiary:!0,type:"error"},{default:()=>[e(S,null,{default:()=>[e(M,null,null)]})]})}})]})},default(){return e(k,{title:o.name,description:o.introduce,titleExtra:o.slug},{default(){return o.description},footer(){return e(oe,{id:o.id},null)}})}})))?s:{default:()=>[s]}),l&&e("div",{class:"flex justify-end"},[e(V,{page:l.currentPage,onUpdatePage:o=>{a.replace({query:{...i.query,page:o},params:{...i.params}})},pageCount:l.totalPage,pageSize:l.size,showQuickJumper:!0},null)]),e(de,{onClose:n,show:Boolean(p||d),id:d,onSubmit:c},null)])}})}});export{Ae as default};
