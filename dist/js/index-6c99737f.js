import{eb as Q,ec as W,ed as Z,ee as J,ef as ee,eg as te,eh as ae,dT as ne,b_ as le,f as _,H as g,w as S,O as re,a as e,bO as k,E as L,j as H,n as I,ei as se,p as oe,ct as ue,bX as z,u as ie,bs as ce,R as h,dR as E,L as N,m as T,ej as O,aN as pe,y as de,ek as fe,bP as me,bR as G,N as b,b5 as ve,S as K,b as w,F as C,q as ye,$ as ge,cx as he,A as we,d as D,I as R,el as be,g as _e,C as Ne}from"./index-23675994.js";import{H as A}from"./rounded-button-7c59c61c.js";import{u as Y}from"./use-react-b6888cd4.js";import{d as Se,l as M}from"./js-yaml-fae8e8ce.js";import{T as Fe}from"./two-col-617cf8dc.js";import{F as xe,S as ke,d as Te,a as y,b as Oe}from"./index-54387177.js";import{C as P}from"./index-3f3ba5dd.js";import{a as Ce,u as $e,p as q}from"./use-async-monaco-7e7ec60e.js";import{_ as Le}from"./CheckCircleOutlined-8b02a6d2.js";import{g as Ae,b as Pe}from"./_baseClone-b061ecc4.js";import{N as V}from"./Form-803b561c.js";import{N as v}from"./FormItem-f55390e0.js";import{N as Ve}from"./Select-96fa6219.js";import{N as je}from"./Switch-ff645ce9.js";import{D as Ee}from"./delete-confirm-8f599212.js";import{T as De}from"./index-74bfa454.js";import{R as Re}from"./relative-time-d95aa895.js";import{u as Me}from"./use-table-470249f6.js";import{E as qe}from"./ExternalLink-5cb14526.js";import{N as U}from"./Tag-cf0fa0d0.js";import{N as Ue}from"./Popconfirm-99c542b2.js";import{N as Be,a as B}from"./Tabs-69d54e13.js";import"./editor.main-2ae2afed.js";import"./use-save-confirm-6f0bbfea.js";import"./index-c6a5c591.js";import"./DataTable-3e4b58c6.js";import"./ArrowDown-cc3d70f2.js";import"./Checkbox-54c2c25e.js";import"./ChevronRight-39fd66c6.js";import"./Tooltip-fa6ed610.js";import"./Pagination-d0fd04b8.js";import"./Forward-4d60d441.js";import"./prop-0f12dfb2.js";import"./Add-17a04330.js";import"./throttle-d4ef57ab.js";function Je(a){var r=a==null?0:a.length;return r?a[r-1]:void 0}function He(a,r){return r.length<2?a:Q(a,W(r,0,-1))}function Ie(a,r){return r=J(r,a),a=He(a,r),a==null||delete a[Z(Je(r))]}function ze(a){return ee(a)?void 0:a}var Ge=1,Ke=2,Ye=4,Xe=te(function(a,r){var s={};if(a==null)return s;var n=!1;r=ae(r,function(i){return i=J(i,a),n||(n=i.length>1),i}),ne(a,Ae(a),s),n&&(s=Pe(s,Ge|Ke|Ye,ze));for(var u=r.length;u--;)Ie(s,r[u]);return s}),Qe=Xe,X={};Object.defineProperty(X,"__esModule",{value:!0});const x=le,We={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 1024 1024"},Ze=(0,x.createElementVNode)("path",{d:"M832 464h-68V240c0-70.7-57.3-128-128-128H388c-70.7 0-128 57.3-128 128v224h-68c-17.7 0-32 14.3-32 32v384c0 17.7 14.3 32 32 32h640c17.7 0 32-14.3 32-32V496c0-17.7-14.3-32-32-32zM540 701v53c0 4.4-3.6 8-8 8h-40c-4.4 0-8-3.6-8-8v-53a48.01 48.01 0 1 1 56 0zm152-237H332V240c0-30.9 25.1-56 56-56h248c30.9 0 56 25.1 56 56v224z",fill:"currentColor"},null,-1),et=[Ze];var tt=X.default=(0,x.defineComponent)({name:"LockFilled",render:function(r,s){return(0,x.openBlock)(),(0,x.createElementBlock)("svg",We,et)}});const at=_({props:{onSave:{type:Function},value:{type:String,required:!0},onChange:{type:Function,required:!0},language:{type:String,required:!0}},setup(a){const r=g(),s=Ce(a),n=$e(r,s,o=>{s.value=o},{language:a.language});S(()=>s.value,o=>{a.onChange(o)});let u=null;re(()=>{u&&(u=clearTimeout(u))});const i=o=>{const c=n.editor;if(!c){u=setTimeout(()=>{i(o)},100);return}const l=c.getModel();if(!l){u=setTimeout(()=>{i(o)},100);return}k(()=>import("./editor.main-2ae2afed.js").then(function(t){return t.e}),["js/editor.main-2ae2afed.js","assets/editor.main.c61113b5.css","js/index-23675994.js","assets/index.eb92906c.css"]).then(t=>{t.editor.setModelLanguage(l,o)})};return S(()=>a.language,o=>{i(o)}),()=>e("div",{class:"h-full w-full relative"},[e("div",{ref:r,class:"h-full w-full relative",style:{display:a.language==="javascript"?"none":""}},null),!n.loaded.value&&e(P,{description:"Monaco \u4F53\u79EF\u8F83\u5927\u8010\u5FC3\u7B49\u5F85\u52A0\u8F7D\u5B8C\u6210..."},null),a.language==="javascript"&&e(xe,{value:s},null)])}}),nt=_({setup(){const a=L(),r=H(),s=I(()=>r.query.id),n=se(s.value?`snippet-${s.value}`:"snippet",new ke),u=oe(s.value?{json:"",yaml:"",text:"",function:""}:{json:JSON.stringify({name:"hello world"},null,2),text:"",yaml:"name: hello world",function:Te});S(()=>n.value.type,l=>{n.value.raw=u[l]}),S(()=>[u.json,u.yaml],ue(([l,t],[p,d])=>{const f=l!==p,m=t!==d,j=ce(u);try{f?j.yaml=Se(JSON.parse(l)):m&&(j.json=JSON.stringify(M(t),null,2))}catch{}},100)),S(()=>[n.value.type,n.value.schema],([l,t])=>{if(l===y.JSON){if(!n.value.schema){k(()=>import("./editor.main-2ae2afed.js").then(function(d){return d.e}),["js/editor.main-2ae2afed.js","assets/editor.main.c61113b5.css","js/index-23675994.js","assets/index.eb92906c.css"]).then(d=>{d.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!1})});return}const p=n.value.schema;fetch(p).then(d=>d.text()).then(d=>{k(()=>import("./editor.main-2ae2afed.js").then(function(f){return f.e}),["js/editor.main-2ae2afed.js","assets/editor.main.c61113b5.css","js/index-23675994.js","assets/index.eb92906c.css"]).then(f=>{f.languages.json.jsonDefaults.setDiagnosticsOptions({validate:!0,schemas:[{uri:p,fileMatch:["*"],schema:JSON.parse(d)}]})})})}}),S(()=>s,async l=>{if(l.value){const t=await h.api.snippets(l.value).get();switch(t.type){case y.JSON:{t.raw=JSON.stringify(JSON.parse(t.raw),null,2);break}}n.value=t,u[t.type]=t.raw}},{immediate:!0});const i=z(),o=ie(),c=async(l=!0)=>{const t=m=>{try{return JSON.stringify(JSON.parse(m),null,0)}catch{o.error("JSON \u683C\u5F0F\u9519\u8BEF")}},p=()=>{const m=u[n.value.type];switch(n.value.type){case y.JSON:return t(m);case y.YAML:{try{M(m)}catch{o.error("YAML \u683C\u5F0F\u9519\u8BEF")}return m}case y.Function:return m;default:return m}},f={...Qe(n.value,["_id","id","created","data"]),raw:p()};f.metatype||delete f.metatype,s.value?await h.api.snippets(s.value).put({data:f}):await h.api.snippets.post({data:f}),o.success(`${s.value?"\u66F4\u65B0":"\u521B\u5EFA"}\u6210\u529F`),l&&a.replace({query:{...r.query,tab:0}})};return Y(()=>(i.setHeaderButtons(e(A,{variant:"success",onClick:()=>c(),icon:e(Le,null,null)},null)),()=>{i.setHeaderButtons(null)})),()=>e(Fe,null,{default:()=>[e(E,{span:12},{default:()=>[e(V,null,{default:()=>[e(v,{label:"\u540D\u79F0",required:!0},{default:()=>[e(N,{onUpdateValue:l=>void(n.value.name=l),value:n.value.name},null)]}),e(v,{label:"\u5F15\u7528",required:!0},{default:()=>[e(N,{value:n.value.reference,onUpdateValue:l=>void(n.value.reference=l),defaultValue:"root"},null)]}),e(v,{label:"\u5143\u7C7B\u578B"},{default:()=>[e(N,{value:n.value.metatype,onUpdateValue:l=>void(n.value.metatype=l)},null)]}),e(v,{label:"\u6570\u636E\u7C7B\u578B"},{default:()=>[e(Ve,{value:n.value.type,defaultValue:y.JSON,onUpdateValue:l=>void(n.value.type=l),options:Object.entries(y).map(([l,t])=>({label:l,value:t}))},null)]}),e(v,{label:"Schema"},{default:()=>[e(N,{value:n.value.schema,onUpdateValue:l=>void(n.value.schema=l)},null)]}),e(v,{label:"\u516C\u5F00",labelPlacement:"left"},{default:()=>[e("div",{class:"w-full flex justify-end"},[e(je,{value:!n.value.private,onUpdateValue:l=>void(n.value.private=!l)},null)])]}),e(v,{label:"\u5907\u6CE8"},{default:()=>[e(N,{resizable:!1,value:n.value.comment,onUpdateValue:l=>void(n.value.comment=l),type:"textarea",rows:4},null)]})]})]}),e(E,{span:24},{default:()=>[e(at,{onSave:async()=>{await c(!1),o.success("Saved!")},language:Oe[n.value.type],value:u[n.value.type],onChange:l=>{u[n.value.type]=l}},null)]})]})}}),lt=_({props:{language:{type:String,required:!0},code:{type:String,required:!0}},setup(a){const r=g();return T(()=>{k(()=>import("./editor.main-2ae2afed.js").then(function(s){return s.e}),["js/editor.main-2ae2afed.js","assets/editor.main.c61113b5.css","js/index-23675994.js","assets/index.eb92906c.css"]).then(s=>{s.editor.colorize(a.code,a.language,{tabSize:2}).then(n=>{r.value.innerHTML=n})})}),()=>e("pre",{ref:r},[a.code])}});var F;(a=>{async function r(){return(await O.rest.repos.get({owner:"mx-space",repo:"snippets"})).data}a.fetchRepo=r;async function s(u=""){return(await O.rest.repos.getContent({owner:"mx-space",repo:"snippets",path:u})).data}a.fetchFileTree=s;async function n(u=""){return(await O.rest.search.code({q:`repo:mx-space/snippets in:path ${u}`,sort:"indexed",order:"desc"})).data}a.searchFile=n})(F||(F={}));function $(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!K(a)}const rt=()=>{const a=g([]),r=g(!0);return[a,async()=>{const n=await F.fetchFileTree();Array.isArray(n)&&(a.value=n.filter(({type:u})=>u==="dir").map(({name:u,html_url:i})=>({name:u,url:i||""}))),r.value=!1},r]},st=_({props:{onFinish:{type:Function,required:!0}},setup(a){const r=g(!1),s=t=>{t.stopPropagation(),t.preventDefault(),l()},[n,u,i]=rt();pe(()=>{r.value&&u()});const o=g(""),c=de(),l=async()=>{const t=c.create({title:"\u83B7\u53D6\u548C\u89E3\u6790",content:()=>ge(ot,{name:o.value,onFinish:()=>{t.destroy(),a.onFinish()}}),closable:!0})};return()=>e(C,null,[e(A,{variant:"info",onClick:()=>{r.value=!0},icon:e(fe,null,null)},null),e(me,{show:r.value,onUpdateShow:t=>{r.value=t}},{default:()=>[e(G,{class:"modal-card sm",title:"\u5BFC\u5165 Snippets"},{default:()=>[e(V,{onSubmit:s},{default:()=>[e(v,{label:"\u5305\u540D"},{default:()=>[e(N,{placeholder:"\u652F\u6301\u5BFC\u5165 GitHub repo:mx-space/snippets \u4E0B\u7684\u96C6\u5408\u5305\uFF0C\u793A\u4F8B\u8F93\u5165: kami",value:o.value,onUpdateValue:t=>{o.value=t}},null)]}),e(v,{label:"\u53EF\u83B7\u53D6\u7684"},{default:()=>[i.value?e(P,null,null):e("div",{class:"flex flex-wrap space-x-2"},[n.value.map(({name:t,url:p})=>e("div",{class:"flex items-center ml-4",key:"name"},[e(b,{text:!0,onClick:()=>{o.value=t,ve(()=>{l()})}},$(t)?t:{default:()=>[t]}),e("a",{href:p,target:"_blank",rel:"noopener noreferrer"},[e(qe,{class:"!h-4 !w-4 ml-2"},null)])]))])]}),e("div",{class:"flex justify-end"},[e(b,{round:!0,type:"primary",onClick:l},{default:()=>[w("\u5904\u7406")]})])]})]})]})])}}),ot=_({props:{name:{type:String,required:!0},onFinish:{type:Function,required:!0}},setup(a){const r=g(!0),s=g([]),n=g([]);T(async()=>{const i=await F.fetchFileTree(a.name);if(Array.isArray(i)){const o=i.map(async c=>{if(c.type==="dir")switch(c.name){case"functions":{const l=await F.fetchFileTree(`${a.name}/functions`);Array.isArray(l)&&await Promise.all(l.map(async t=>{if(t.type==="file"&&/\.(js|ts)$/.test(t.name)){const p=t.download_url;if(!p){message.error(`\u83B7\u53D6\u4E0B\u8F7D\u5730\u5740\u5931\u8D25, ${t.name}`);return}const d=await fetch(p).then(f=>f.text());console.log(`// ${t.name}
${d}`),s.value.push({name:t.name,reference:a.name,raw:d,htmlUrl:t.html_url})}}));break}}else if(c.name==="package.json"){const l=c.download_url;if(!l){message.error("\u65E0\u6CD5\u83B7\u53D6 package.json \u6587\u4EF6\u7684\u4E0B\u8F7D\u5730\u5740");return}const t=await fetch(l).then(d=>d.text()),p=JSON.parse(t);console.log("// package.json"),console.log(p),n.value=Object.entries(p.dependencies||{}).map(([d,f])=>`${d}@${f}`)}});await Promise.all(o),r.value=!1}});const u=async()=>{const i={snippets:s.value.map(c=>({name:q.basename(c.name,q.extname(c.name)),reference:c.reference,raw:c.raw,private:!1,type:y.Function})),packages:he(n)},o=message.loading("\u6B63\u5728\u5BFC\u5165...",{duration:1e6});await h.api.snippets.more.post({data:i,timeout:1e6}),o.destroy(),message.success("\u5BFC\u5165\u6210\u529F"),a.onFinish()};return()=>{const{name:i}=a;return e("div",null,[e("p",null,[w("\u83B7\u53D6\uFF1A "),i]),r.value?e("div",{class:"h-24 relative"},[e(P,{description:"\u9700\u8981\u4ECE GitHub \u83B7\u53D6\uFF0C\u5EFA\u8BAE\u8FDE\u63A5\u4EE3\u7406\u540E\u64CD\u4F5C\u3002"},null)]):e(V,null,{default:()=>[e(v,{label:"\u5C06\u5BFC\u5165\u7684\u51FD\u6570\uFF1A"},{default:()=>[e("div",{class:"space-x-2"},[s.value.map(({name:o,reference:c,raw:l,htmlUrl:t},p)=>e(ye,{key:`${c}/${o}`,trigger:"hover",placement:"right"},{trigger(){return e(b,{text:!0,onClick:()=>{t&&window.open(t)},class:"cursor-pointer"},{default:()=>[e(U,{closable:!0,onClose:d=>{d.stopPropagation(),s.value.splice(p,1)}},$(o)?o:{default:()=>[o]})]})},default(){return e(G,{bordered:!1,title:o,class:"max-w-[40vw] max-h-[50vh] overflow-auto"},{default:()=>[e(lt,{code:l,language:"typescript"},null)]})}}))])]}),e(v,{label:"\u5C06\u5B89\u88C5\u7684\u4F9D\u8D56\uFF1A"},{default:()=>[e("div",{class:"space-x-2"},[n.value.map((o,c)=>e(U,{closable:!0,key:o,onClose:()=>{n.value.splice(c,1)}},$(o)?o:{default:()=>[o]}))])]}),e("div",{class:"flex justify-end"},[e(b,{round:!0,type:"primary",onClick:u},{default:()=>[w("\u5BFC\u5165")]})])]})])}}});function ut(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!K(a)}const it=()=>{const a=g([]),r=async()=>{const s=await h.api.snippets.aggregate.post({data:[{$group:{_id:"$reference"}},{$project:{name:"$_id",_id:!1}}]});a.value=s.data.map(({name:n})=>n)};return T(()=>{r()}),a},ct=_({setup(){const{data:a,fetchDataFn:r,loading:s,pager:n,checkedRowKeys:u}=Me((l,t)=>async(p,d,f)=>{const m=await h.api.snippets.get({params:{page:p,size:d,select:"-raw",db_query:f}});l.value=m.data,t.value=m.pagination}),i=it();T(()=>{r(1,20)});const o=z();Y(()=>(o.setHeaderButtons(e(C,null,[e(A,{onClick:()=>{c.push({query:{tab:1}})},icon:e(we,null,null)},null),e(st,{onFinish:()=>{r()}},null),e(Ee,{checkedRowKeys:u,onDelete:async l=>{!l||(await Promise.all(l.map(t=>h.api.snippets(t).delete())),r(1,20),u.value.length=0)}},null)])),()=>{o.setHeaderButtons(null)}));const c=L();return()=>{const l=i.value.map(t=>({label:t,value:t}));return e(C,null,[e(De,{onUpdateCheckedRowKeys:t=>{u.value=t},data:a,nTableProps:{onUpdateFilters(t){t.reference&&t.reference.length?r(1,20,{$or:t.reference.map(p=>({reference:p}))}):r(1,20)}},pager:n,columns:[{type:"selection",options:["none","all"]},{key:"name",title:"\u540D\u79F0",render(t){const p=t.name,d=t.private;return e(D,{align:"center"},{default:()=>[t.type===y.Function&&e(R,null,{default:()=>[e(be,null,null)]}),e(b,{tag:"a",text:!0,href:`${h.endpoint+(t.type===y.Function?"/fn/":"/snippets/")+t.reference}/${t.name}${t.private?`?token=${_e()}`:""}`,target:"_blank",size:"tiny"},ut(p)?p:{default:()=>[p]}),d&&e(R,{class:"items-center flex "},{default:()=>[e(tt,null,null)]})]})}},{title:"\u7C7B\u578B",key:"type"},{title:"\u5F15\u7528",key:"reference",filter:!0,filterOptions:l},{key:"comment",title:"\u5907\u6CE8",width:300,ellipsis:{tooltip:!0}},{title:"\u521B\u5EFA\u4E8E",key:"created",render(t){return e(Re,{time:t.created},null)}},{title:"\u64CD\u4F5C",key:"id",fixed:"right",render(t){return e(D,null,{default:()=>[e(b,{text:!0,size:"tiny",type:"primary",onClick:()=>{c.push({query:{tab:1,id:t.id}})}},{default:()=>[w("\u7F16\u8F91")]}),e(Ue,{positiveText:"\u53D6\u6D88",negativeText:"\u5220\u9664",onNegativeClick:async()=>{await h.api.snippets(t.id).delete(),message.success("\u5220\u9664\u6210\u529F"),await r(n.value.currentPage)}},{trigger:()=>e(b,{text:!0,type:"error",size:"tiny"},{default:()=>[w("\u79FB\u9664")]}),default:()=>e("span",{class:"max-w-48"},[w("\u786E\u5B9A\u8981\u5220\u9664 "),t.title,w(" ?")])})]})}}],loading:s.value},null)])}}});var zt=_({name:"SnippetView",setup(){const a=H(),r=L(),s=I(()=>a.query.tab||"0");return()=>e(Ne,null,{default:()=>[e(Be,{size:"medium",value:s.value,onUpdateValue:n=>{r.push({query:{tab:n}})}},{default:()=>[e(B,{name:"0",tab:"\u5217\u8868"},{default:()=>[e(ct,null,null)]}),e(B,{name:"1",tab:"\u7F16\u8F91",displayDirective:"if"},{default:()=>[e(nt,null,null)]})]})]})}});export{zt as default};
